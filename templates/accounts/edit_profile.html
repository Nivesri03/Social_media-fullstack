{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}

{% block title %}Edit Profile - Xeox{% endblock %}

{% block content %}
<div class="feed-container">
    <div class="post-card">
        <div class="post-header" style="justify-content: center; padding: 1.5rem;">
            <h3 style="color: var(--xeox-dark); margin: 0;">
                <i class="fas fa-edit me-2" style="color: var(--xeox-purple);"></i>
                Edit Profile
            </h3>
        </div>
    </div>

    <div class="post-card">
        <div style="padding: 2rem;">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Profile Picture Section -->
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}"
                                 class="rounded-circle mb-3" id="profilePreview"
                                 style="width: 120px; height: 120px; object-fit: cover; border: 3px solid var(--xeox-light);">
                            {% else %}
                            <div class="rounded-circle mb-3 d-flex align-items-center justify-content-center" id="profilePreview"
                                 style="width: 120px; height: 120px; background: linear-gradient(135deg, var(--xeox-purple), var(--xeox-mauve)); color: white; font-size: 2rem; font-weight: bold;">
                                {{ user.username|first|upper }}
                            </div>
                            {% endif %}
                            <label for="{{ form.profile_picture.id_for_label }}"
                                   class="btn btn-sm position-absolute bottom-0 end-0 rounded-circle"
                                   style="width: 35px; height: 35px; background: linear-gradient(135deg, var(--xeox-purple), var(--xeox-mauve)); color: white; border: 2px solid white;">
                                <i class="fas fa-camera"></i>
                            </label>
                        </div>
                        <div class="mt-2">
                            {{ form.profile_picture|add_class:"form-control" }}
                            {% if form.profile_picture.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.profile_picture.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Username Field -->
                    <div class="mb-3">
                        <label for="id_username" class="form-label" style="color: var(--xeox-dark); font-weight: 600;">
                            <i class="fas fa-at me-2" style="color: var(--xeox-purple);"></i>Username
                        </label>
                        <input type="text" name="username" value="{{ user.username }}" class="form-control" id="id_username"
                               style="border: 2px solid rgba(42, 20, 75, 0.1); border-radius: var(--border-radius-sm);">
                        <div class="form-text" style="color: var(--xeox-mauve);">Your unique username for Xeox</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.first_name.id_for_label }}" class="form-label" style="color: var(--xeox-dark); font-weight: 600;">
                                <i class="fas fa-user me-2" style="color: var(--xeox-purple);"></i>First Name
                            </label>
                            {{ form.first_name|add_class:"form-control"|attr:"style:border: 2px solid rgba(42, 20, 75, 0.1); border-radius: var(--border-radius-sm);" }}
                            {% if form.first_name.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.first_name.errors }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.last_name.id_for_label }}" class="form-label" style="color: var(--xeox-dark); font-weight: 600;">
                                <i class="fas fa-user me-2" style="color: var(--xeox-purple);"></i>Last Name
                            </label>
                            {{ form.last_name|add_class:"form-control"|attr:"style:border: 2px solid rgba(42, 20, 75, 0.1); border-radius: var(--border-radius-sm);" }}
                            {% if form.last_name.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.last_name.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">
                            <i class="fas fa-envelope me-2"></i>Email Address
                        </label>
                        {{ form.email|add_class:"form-control" }}
                        {% if form.email.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.email.errors }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.bio.id_for_label }}" class="form-label">
                            <i class="fas fa-quote-left me-2"></i>Bio
                        </label>
                        {{ form.bio|add_class:"form-control" }}
                        <div class="form-text">Tell people a little about yourself (max 500 characters)</div>
                        <div class="text-end">
                            <small class="text-muted">
                                <span id="bioCount">{{ form.bio.value|length|default:0 }}</span>/500
                            </small>
                        </div>
                        {% if form.bio.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.bio.errors }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                                <i class="fas fa-birthday-cake me-2"></i>Date of Birth
                            </label>
                            {{ form.date_of_birth|add_class:"form-control" }}
                            {% if form.date_of_birth.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.date_of_birth.errors }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.location.id_for_label }}" class="form-label">
                                <i class="fas fa-map-marker-alt me-2"></i>Location
                            </label>
                            {{ form.location|add_class:"form-control" }}
                            {% if form.location.errors %}
                            <div class="text-danger small mt-1">
                                {{ form.location.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="{{ form.website.id_for_label }}" class="form-label">
                            <i class="fas fa-link me-2"></i>Website
                        </label>
                        {{ form.website|add_class:"form-control" }}
                        <div class="form-text">Include http:// or https://</div>
                        {% if form.website.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.website.errors }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'accounts:profile' user.username %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Account Settings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Account Settings
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Change Password</h6>
                        <p class="text-muted small">Update your password to keep your account secure.</p>
                        <a href="{% url 'accounts:password_reset' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-key me-2"></i>Change Password
                        </a>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Privacy Settings</h6>
                        <p class="text-muted small">Control who can see your posts and profile.</p>
                        <button class="btn btn-outline-secondary btn-sm" disabled>
                            <i class="fas fa-shield-alt me-2"></i>Privacy Settings
                        </button>
                        <small class="text-muted d-block mt-1">Coming soon</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Profile picture preview
document.getElementById('{{ form.profile_picture.id_for_label }}').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profilePreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Bio character counter
const bioField = document.getElementById('{{ form.bio.id_for_label }}');
const bioCounter = document.getElementById('bioCount');

bioField.addEventListener('input', function() {
    const count = this.value.length;
    bioCounter.textContent = count;
    
    if (count > 500) {
        bioCounter.parentElement.classList.add('text-danger');
        bioCounter.parentElement.classList.remove('text-muted');
    } else {
        bioCounter.parentElement.classList.remove('text-danger');
        bioCounter.parentElement.classList.add('text-muted');
    }
});

// Auto-resize bio textarea
bioField.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const website = document.getElementById('{{ form.website.id_for_label }}').value;
    if (website && !website.match(/^https?:\/\/.+/)) {
        e.preventDefault();
        alert('Please include http:// or https:// in your website URL');
        return false;
    }
    
    // Add loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    submitBtn.disabled = true;
});
</script>
{% endblock %}
