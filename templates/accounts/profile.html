{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile_user.get_full_name|default:profile_user.username }} - Xeox{% endblock %}

{% block body_attributes %} data-page="profile"{% endblock %}

{% block content %}
<div class="profile-page">
    <!-- Profile Header -->
    <div class="profile-header-modern">
        <!-- Profile Picture -->
        <div class="profile-picture-container">
            {% if profile_user.profile_picture %}
            <img src="{{ profile_user.profile_picture.url }}" alt="{{ profile_user.username }}" class="profile-picture-large">
            {% else %}
            <div class="profile-picture-large profile-picture-default">
                {{ profile_user.username|first|upper }}
            </div>
            {% endif %}
        </div>

        <!-- Name and Username -->
        <div class="profile-name-section">
            <h1 class="profile-display-name">{{ profile_user.get_full_name|default:profile_user.username }}</h1>
            <p class="profile-username">@{{ profile_user.username }}</p>
            <div class="verified-badge">
                <i class="fas fa-check-circle"></i> Verified
            </div>
        </div>

        <!-- Stats -->
        <div class="profile-stats">
            <div class="stat-item">
                <strong class="stat-number">1</strong>
                <span class="stat-label">Posts</span>
            </div>
            <div class="stat-item">
                <strong class="stat-number">0</strong>
                <span class="stat-label">Followers</span>
            </div>
            <div class="stat-item">
                <strong class="stat-number">0</strong>
                <span class="stat-label">Following</span>
            </div>
        </div>

        <!-- Bio -->
        <div class="profile-bio">
            {% if profile_user.bio %}
            <p>{{ profile_user.bio }}</p>
            {% else %}
            <p>üåü A girl romanticizing life Code. Create. Glow ‚ú® üíª Full Stack Dev | AI Babe üì∏ capturing moments ‚Ä¢ sharing joy ü§ù DM for collabs & kindness üíú</p>
            {% endif %}
        </div>

        <!-- Action Buttons -->
        <div class="profile-actions">
            {% if is_own_profile %}
            <a href="{% url 'accounts:edit_profile' %}" class="btn-edit-profile">
                <i class="fas fa-edit"></i> Edit Profile
            </a>
            <form method="post" action="{% url 'accounts:logout' %}" class="logout-form">
                {% csrf_token %}
                <button type="submit" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </form>
            {% else %}
            <button class="btn-follow follow-btn" data-username="{{ profile_user.username }}">
                {% if is_following %}
                <i class="fas fa-user-minus"></i> Unfollow
                {% else %}
                <i class="fas fa-user-plus"></i> Follow
                {% endif %}
            </button>
            <button class="btn-message">
                <i class="fas fa-envelope"></i> Message
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Posts Section -->
    <div id="posts-section">
            {% if posts %}
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; margin-top: 1rem;">
                {% for post in posts %}
                <div class="post-grid-item" data-post-id="{{ post.id }}" style="aspect-ratio: 1; position: relative; cursor: pointer;">
                    {% if post.image %}
                    <img src="{{ post.image.url }}" alt="Post" style="width: 100%; height: 100%; object-fit: cover;">
                    {% elif post.video %}
                    <video style="width: 100%; height: 100%; object-fit: cover;">
                        <source src="{{ post.video.url }}" type="video/mp4">
                    </video>
                    <div style="position: absolute; top: 0.5rem; right: 0.5rem; color: white;">
                        <i class="fas fa-video"></i>
                    </div>
                    {% else %}
                    <div style="width: 100%; height: 100%; background: linear-gradient(135deg, var(--xeox-light), var(--xeox-rose)); display: flex; align-items: center; justify-content: center; padding: 0.5rem;">
                        <div style="text-align: center; color: var(--xeox-dark);">
                            <i class="fas fa-quote-left" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <p style="font-size: 0.8rem; margin: 0;">{{ post.content|truncatewords:5 }}</p>
                        </div>
                    </div>
                    {% endif %}



                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: white; padding: 0.5rem; font-size: 0.8rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>{{ post.created_at|timesince }}</span>
                            <div>
                                <span style="margin-right: 0.5rem;">
                                    <i class="fas fa-heart"></i> {{ post.likes_count }}
                                </span>
                                <span>
                                    <i class="fas fa-comment"></i> {{ post.comments_count }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="post-card text-center" style="padding: 3rem 1rem; margin-top: 1rem;">
                <i class="fas fa-camera fa-3x" style="color: var(--xeox-mauve); margin-bottom: 1rem;"></i>
                <h4 style="color: var(--xeox-dark);">No posts yet</h4>
                {% if is_own_profile %}
                <p style="color: var(--xeox-mauve);">Share your first post to get started!</p>
                <button class="action-btn" onclick="openCreateModal()" style="background: linear-gradient(135deg, var(--xeox-purple), var(--xeox-mauve)); color: white; padding: 0.75rem 1.5rem;">
                    <i class="fas fa-plus"></i>
                    <span>Create Post</span>
                </button>
                {% else %}
                <p style="color: var(--xeox-mauve);">{{ profile_user.get_full_name|default:profile_user.username }} hasn't posted anything yet.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Post Options Modal -->
<div class="modal fade" id="postOptionsModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body p-0">
                <button class="btn btn-danger w-100 rounded-0" id="deletePostBtn" style="border-radius: 0;">
                    <i class="fas fa-trash me-2"></i>Delete Post
                </button>
                <button class="btn btn-secondary w-100 rounded-0" data-bs-dismiss="modal">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{% csrf_token %}
<script>
let tapCount = 0;
let tapTimer = null;
let selectedPostId = null;

// Double-tap handler for post options
document.addEventListener('click', function(e) {
    const postGridItem = e.target.closest('.post-grid-item');
    if (postGridItem && {{ is_own_profile|yesno:"true,false" }}) {
        tapCount++;

        if (tapCount === 1) {
            tapTimer = setTimeout(function() {
                // Single tap - navigate to post
                const postId = postGridItem.dataset.postId;
                window.location.href = `/posts/${postId}/`;
                tapCount = 0;
            }, 300);
        } else if (tapCount === 2) {
            // Double tap - show options
            clearTimeout(tapTimer);
            tapCount = 0;

            selectedPostId = postGridItem.dataset.postId;
            const modal = new bootstrap.Modal(document.getElementById('postOptionsModal'));
            modal.show();
        }
    } else if (postGridItem) {
        // Not own profile - just navigate
        const postId = postGridItem.dataset.postId;
        window.location.href = `/posts/${postId}/`;
    }
});

// Delete post functionality
document.getElementById('deletePostBtn').addEventListener('click', function() {
    if (selectedPostId) {
        fetch('/posts/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: `post_id=${selectedPostId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'deleted') {
                // Remove the post from the grid
                const postGridItem = document.querySelector(`[data-post-id="${selectedPostId}"]`);
                postGridItem.remove();

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('postOptionsModal'));
                modal.hide();

                // Show success message
                alert('Post deleted successfully!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting post. Please try again.');
        });
    }
});

// Follow button functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.follow-btn')) {
        const btn = e.target.closest('.follow-btn');
        const username = btn.dataset.username;

        fetch('/accounts/follow/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: `username=${username}`
        })
        .then(response => response.json())
        .then(data => {
            const icon = btn.querySelector('i');
            const text = btn.querySelector('span');

            if (data.status === 'followed') {
                icon.className = 'fas fa-user-minus';
                text.textContent = 'Unfollow';
                btn.style.background = 'var(--xeox-mauve)';
            } else {
                icon.className = 'fas fa-user-plus';
                text.textContent = 'Follow';
                btn.style.background = 'linear-gradient(135deg, var(--xeox-purple), var(--xeox-mauve))';
            }

            // Update follower count if element exists
            const followerCount = document.querySelector('.followers-count');
            if (followerCount) {
                followerCount.textContent = data.followers_count;
            }
        });
    }
});

// Open create modal function
function openCreateModal(type = 'text') {
    // This would open the create post modal
    window.location.href = '/posts/create/';
}
</script>
{% endblock %}
