{% extends 'base.html' %}
{% load static %}

{% block title %}Messages - CAMIGO{% endblock %}

{% block content %}
<div class="feed-container">
    <!-- Header -->
    <div class="post-card">
        <div class="post-header" style="justify-content: center; padding: 1.5rem;">
            <h3 style="color: var(--xeox-dark); margin: 0;">
                <i class="fas fa-comment me-2" style="color: var(--xeox-purple);"></i>
                Messages
            </h3>
        </div>
    </div>

    <!-- Demo Chat Info -->
    <div class="post-card">
        <div style="padding: 1.5rem; text-align: center; background: linear-gradient(135deg, var(--xeox-light), var(--xeox-rose)); border-radius: var(--border-radius);">
            <i class="fas fa-users fa-2x" style="color: var(--xeox-purple); margin-bottom: 1rem;"></i>
            <h4 style="color: var(--xeox-dark);">Demo Chat Room</h4>
            <p style="color: var(--xeox-mauve); margin-bottom: 1rem;">
                Chat with other users using the same demo credentials (xyz@gmail.com)
            </p>
            <div style="background: white; padding: 1rem; border-radius: var(--border-radius-sm); margin-bottom: 1rem;">
                <strong style="color: var(--xeox-dark);">Demo Credentials:</strong><br>
                <span style="color: var(--xeox-mauve);">Email: xyz@gmail.com</span><br>
                <span style="color: var(--xeox-mauve);">Password: abcdefghijk</span>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="post-card">
        <div id="chat-messages" style="height: 400px; overflow-y: auto; padding: 1rem; background: var(--xeox-light); border-radius: var(--border-radius-sm); margin-bottom: 1rem;">
            {% for message in messages %}
            <div class="message-item {% if message.sender == user %}sent{% else %}received{% endif %}" style="margin-bottom: 1rem;">
                <div class="message-bubble" style="
                    max-width: 70%;
                    padding: 0.75rem 1rem;
                    border-radius: 18px;
                    {% if message.sender == user %}
                        background: linear-gradient(135deg, var(--xeox-purple), var(--xeox-mauve));
                        color: white;
                        margin-left: auto;
                        text-align: right;
                    {% else %}
                        background: white;
                        color: var(--xeox-dark);
                        margin-right: auto;
                    {% endif %}
                ">
                    {% if message.sender != user %}
                    <div style="font-size: 0.8rem; color: var(--xeox-mauve); margin-bottom: 0.25rem;">
                        {{ message.sender.username }}
                    </div>
                    {% endif %}
                    <div>{{ message.content }}</div>
                    <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem;">
                        {{ message.created_at|date:"H:i" }}
                    </div>
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; color: var(--xeox-mauve); padding: 2rem;">
                <i class="fas fa-comment-slash fa-2x" style="margin-bottom: 1rem;"></i>
                <p>No messages yet. Start a conversation!</p>
            </div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <form id="messageForm" style="display: flex; gap: 0.5rem;">
            {% csrf_token %}
            <input type="hidden" name="recipient_id" value="1"> <!-- Demo recipient -->
            <input type="text" name="content" id="messageInput" placeholder="Type a message..." 
                   style="flex: 1; padding: 0.75rem; border: 2px solid rgba(42, 20, 75, 0.1); border-radius: 20px; outline: none;">
            <button type="submit" style="
                background: linear-gradient(135deg, var(--xeox-purple), var(--xeox-mauve));
                color: white;
                border: none;
                border-radius: 50%;
                width: 45px;
                height: 45px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            ">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>

<script>
// Auto-scroll to bottom of messages
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
});

// Handle message form submission
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const messageInput = document.getElementById('messageInput');
    const content = messageInput.value.trim();
    
    if (!content) return;
    
    // Add message to chat immediately (optimistic update)
    addMessageToChat(content, '{{ user.username }}', 'now', true);
    messageInput.value = '';
    
    // Send to server
    fetch('/api/send-message/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'success') {
            console.error('Failed to send message');
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
    });
});

function addMessageToChat(content, sender, time, isSent) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-item ${isSent ? 'sent' : 'received'}`;
    messageDiv.style.marginBottom = '1rem';
    
    messageDiv.innerHTML = `
        <div class="message-bubble" style="
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            ${isSent ? 
                'background: linear-gradient(135deg, var(--xeox-purple), var(--xeox-mauve)); color: white; margin-left: auto; text-align: right;' : 
                'background: white; color: var(--xeox-dark); margin-right: auto;'
            }
        ">
            ${!isSent ? `<div style="font-size: 0.8rem; color: var(--xeox-mauve); margin-bottom: 0.25rem;">${sender}</div>` : ''}
            <div>${content}</div>
            <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem;">${time}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
</script>
{% endblock %}
